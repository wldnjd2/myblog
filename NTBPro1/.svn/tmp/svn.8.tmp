<%@ page language="java" contentType="text/html; charset=UTF-8"
    pageEncoding="UTF-8"%>
<%@ taglib prefix="c" uri="http://java.sun.com/jsp/jstl/core" %>
<%@ taglib prefix="fmt" uri="http://java.sun.com/jsp/jstl/fmt" %>
<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>내가시스템 :: 기술게시판</title>
<%@ include file="/WEB-INF/jsp/admin/admin.jsp" %>
<link rel="stylesheet" href="<c:url value='css/main/main.css' />">
<script src="<c:url value='js/main/tech_paging.js'/>"></script>
<link href="https://cdnjs.cloudflare.com/ajax/libs/semantic-ui/2.2.2/semantic.min.css" rel="stylesheet" type="text/css">
<script
      src="https://code.jquery.com/jquery-3.1.1.min.js"
      integrity="sha256-hVVnYaiADRTO2PzUGmuLJr8BLUSjGIZsDYGmIJLv2b8="
      crossorigin="anonymous"></script>
<script src="Semantic-UI-CSS-master/semantic.min.js"></script>
<style type="text/css">
	#all_div{
		z-index: 10;
	}
	/* 공통 부분 시작 */
	#modal_back{
		display: none; /* Hidden by default */
		position: fixed; /* Stay in place */
		z-index: 10; /* Sit on top */
		left: 0;
		top: 0;
		width: 100%; /* Full width */
		height: 100%; /* Full height */
		overflow: auto; /* Enable scroll if needed */
		background-color: rgb(0,0,0); /* Fallback color */
		background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
	}
	#wrap{
		background-color: #fefefe;
		margin: 15% auto; /* 15% from the top and centered */
		padding: 20px;
		border: 1px solid #888;
		width: 40%; /* Could be more or less, depending on screen size */	
	}
	
	.clear{
	    clear: both;
	}
	/* 공통 부분 종료 */
	
	/* header 부분 시작 */
	#header{
	    padding-bottom: 50px;
	    text-align: center;
	}
	/* header 부분 종료 */
	
	/* main_left 부분 시작 */
	#main_left{
	    margin: 0 50px 0 70px;
	    width: 100px;
	    float: left;
	}
	#img_btn{
	    margin-top: 10px;
	}
	.thumb{
		border-radius: 50%;
	}
	#image_field #image_field_upload { 
		display: inline-block; 
		padding: .5em .75em; 
		color: #999; 
		font-size: inherit; 
		line-height: normal; 
		vertical-align: middle; 
		background-color: #fdfdfd; 
		cursor: pointer; 
		border: 1px solid #ebebeb;
		border-bottom-color: #e2e2e2; 
		border-radius: .25em; 
	} 
	#image_field input[type="file"] { /* 파일 필드 숨기기 */ 
	position: absolute; 
	width: 1px; 
	height: 1px; 
	padding: 0; 
	margin: -1px; 
	overflow: hidden; 
	clip:rect(0,0,0,0); 
	border: 0; 
	}

	/* main_left 부분 종료 */
	
	/* main_right 부분 시작 */
	#main_right{
	    width: 350px;
	    float: left;
	}
	.message{
	    display: none;
	}
	.none{
	    display: none;
	}
	.fr{
	    float: right;
	}
	/* main_right 부분 종료 */
	
	/* footer 부분 시작*/
	#footer{
	    margin: 30px 0 30px 0;
	    text-align: center;
	}
	/* footer 부분 종료*/
</style>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
<script type="text/javascript">

	
	function closeModal() {
		$('#modal_back').hide();
	};
	$(function(){
		$("#login_btn").click(function(){
			$(location).attr("href", "${pageContext.request.contextPath}/login/logIn.do");
		});
		
		$("#logout_btn").click(function(){
			$(location).attr("href", "${pageContext.request.contextPath}/login/logOut.do")
		});
		
		$("#update_btn").click(function(){

			$("#modal_back").css("display","block");

		});
		
		/* 회원 정보 수정 */
		$("#updateUser_btn").click(function(){
			var inputFile = $("input[name='uploadFile']");
			var files = inputFile[0].files;
			
			var form = $("#frm_update")[0];
			var formData = new FormData(form);
			
			$.ajax({
				type: "POST",
				data: formData,	// json(전송) 타입
				url: "${pageContext.request.contextPath}/account/updateUserWrite.do",
				contentType : false,
		        processData : false,
		        cache : false,
				
				success: function(result){
					if(result == "ok"){
						alert("회원정보 수정이 완료되었습니다.");
						$("#modal_back").css("display", "none")
						$("#user_pw").val("");
					} else{
						alert("회원정보 수정이 실패하였습니다.<br>(비밀번호를 한번 확인해주세요.");
					}
				},
				error: function(){	//장애 발생
					alert("오류발생");
				}
			});
		});
	});
	
	/* 게시글 클릭 시 상세정보로 이동 */
	function moveToDetail(){
		console.log("test")
	}
	
	/* 관리자 버튼 */
	function moveToAdmin(){
		$(".modal").css("display", "flex");
		pagination_admin(1);
	}
	
	//썸네일
	document.addEventListener('DOMContentLoaded', function(){
		
	    //이미지 객체 타입으로 이미지 확장자 밸리데이션
	    var validateType = function(img){
	        return (['image/jpeg','image/jpg','image/png'].indexOf(img.type) > -1);
	    }
	
	    var validateName = function(fname){
	        let extensions = ['jpeg','jpg','png'];
	        let fparts = fname.split('.');
	        let fext = '';
	    
	        if(fparts.length > 1){
	            fext = fparts[fparts.length-1];
	        }
	    
	        let validated = false;
	        
	        if(fext != ''){
	            extensions.forEach(function(ext){
	                if(ext == fext){
	                }
	            });
	        }
	    
	        return validated;
	    }
	
	    // 파일 선택 필드에 이벤트 리스너 등록
	    document.getElementById('uploadFile').addEventListener('change', function(e){
	        let elem = e.target;
	        if(validateType(elem.files[0])){
	            let preview = document.querySelector('.thumb');
	            preview.src = URL.createObjectURL(elem.files[0]); //파일 객체에서 이미지 데이터 가져옴.
	            document.querySelector('.dellink').style.display = 'block'; // 이미지 삭제 링크 표시
	            preview.onload = function() {
	                URL.revokeObjectURL(preview.src); //URL 객체 해제
	            }
	        }else{
	        console.log('이미지 파일이 아닙니다.');
	        }
	    });
	
	    document.querySelector('.dellink').addEventListener('click', function(e){
	        let dellink = e.target;
	        let preview = dellink.previousElementSibling;
	        preview.src = "<c:url value='/'/>images/라이언 사진.png"; // 썸네일 이미지 src 데이터 해제
	        document.querySelector('.dellink').style.display = 'none';
	    });
	});
</script>
</head>
<body>
	<div id="all_div">
		<header>
			<div id="menu">
				<c:choose>
					<c:when test="${not empty Session_user_id}">
						<button>${Session_user_id}</button>
					</c:when>
				</c:choose>
				<input class="menu-btn" type="button" value="관리자" onclick="moveToAdmin()" />
				
				<c:choose>
					<c:when test="${not empty Session_user_id}">
						<input id="update_btn" class="menu-btn" type="button" value="정보수정" />
						<input id="logout_btn" class="menu-btn" type="button" value="로그아웃"/>
					</c:when>
					<c:otherwise>
						<input id="login_btn" class="menu-btn" type="button" value="로그인" />
					</c:otherwise>
				</c:choose>
			</div>
		</header>
		
		<div id="logo-div">
			<div id="logo-img">
				<img src='<c:url value="/images/logo.png"/>' alt="로고" />
			</div>
		</div>
		
			<div id="board-category">
				<div id="category">
			
					<button class="ui grey button" onclick="category_pagination(1, '')">전체</button>
					<c:forEach var="category" items="${resultCategory }">
						<button class="ui grey button" onclick="category_pagination(1, '${category.cat_cname}');"><c:out value='${category.cat_cname }'/></button>
					</c:forEach>
				</div>
			</div>
			
		<div id="board-div">
			<div id="board">
			<input type="hidden" id="cp" value="<c:out value='${paginationInfo.currentPageNo}'/>" />
			<input type="hidden" id="pageSize" value="<c:out value='${paginationInfo.pageSize }' />" />
			<input type="hidden" id="totalPage" value="<c:out value='${resultCnt/paginationInfo.recordCountPerPage}'/>"/>	
			<input type="hidden" id="category_name" value="<c:out value='${boardVO.cat_cname }'/>"/>
				<table class="ui celled table">
					<colgroup>
						<col width="50px">
						<col width="60px">
						<col width="230px">
						<col width="50px">
						<col width="70px">
						<col width="40px">
					</colgroup>
					<thead>
						<tr>
							<th>번호</th>
							<th>카테고리</th>
							<th>제목</th>
							<th>작성자</th>
							<th>날짜</th>
							<th>조회수</th>
						</tr>
					</thead>
					<c:forEach var="result" items="${resultList }" >
						<tr class="tr-sync" onclick="moveToDetail();">
							<td data-label="번호"><c:out value="${result.post_pnum }" /></td>
							<td data-label="카테고리"><c:out value="${result.cat_cname }"/></td>
							<td data-label="제목"><c:out value="${result.post_title }"/></td>
							<td data-label="작성자"><c:out value="${result.user_id }"/></td>
							<td data-label="날짜"><c:out value="${result.post_regdate }"/></td>
							<td data-label="조회수"><c:out value="${result.post_hits }"/></td>
						</tr>
					</c:forEach>
					<tr id="tr-async1" class="tr-async" onclick="moveToDetail();"></tr>
					<tr id="tr-async2" class="tr-async" onclick="moveToDetail();"></tr>
					<tr id="tr-async3" class="tr-async" onclick="moveToDetail();"></tr>
					<tr id="tr-async4" class="tr-async" onclick="moveToDetail();"></tr>
					<tr id="tr-async5" class="tr-async" onclick="moveToDetail();"></tr>
					<tr id="tr-async6" class="tr-async" onclick="moveToDetail();"></tr>
				</table>
				<div id="pagination">
					<c:forEach var="pageNum" begin="1" end="${paginationInfo.pageSize }">
						<a class="paging" href="javascript:void(0)" onclick="javascript:pagination(${pageNum});"><c:out value="${pageNum }"/></a>
					</c:forEach>
						<a href="javascript:void(0)" onclick="javascript:pageMove(${paginationInfo.pageSize}, ${paginationInfo.currentPageNo}, 'next')"><c:out value="다음"/></a>
				</div>
				<div><input type="button" value="작성" style="float: right;" /></div>
				
			</div>
		</div>
	</div>
	<div id="modal_back">
		<div id="wrap">
	        <div id="header">
	            <h1>사용자 정보수정</h1>
	        </div>
	        <form name = "updateUser" id="frm_update">
		        <div class="ui form success error">
		        	<c:forEach var="avo" items="${MemberVO }" >
			            <div id="main_left">
			                <div class="field" id="image_field">
			                    <label>대표 이미지</label>
			                    <label for="uploadFile" id="image_field_upload">업로드</label>
			                    <input type="file" id="uploadFile" accept="image/jpeg, image/jpg, image/png" name="uploadFile">
			                    <img class="thumb" src="/NTBimages/${avo.user_img }" style="width: 100px; height: 100px;">
			                    <a href="javascript:void(0);" class="dellink">파일 삭제</a>
			                </div>
			            </div>
			
			            <div id="main_right">
			                <div class="field">
			                    <label>아이디</label>
			                    <input id="inputID" type="text" name="user_id" value="${avo.user_id }" readonly>
			                </div>
			
			                <div class="field">
			                    <label>이름</label>
			                    <input type="text" id="user_name" name="user_name" value="${avo.user_name }" readonly>
			                </div>
			    
			                <div class="field">
			                    <label>비밀번호 *</label>
			                    <input type="password" id="user_pw" name="user_pw">
			                </div>
			    
			                <div class="field">
			                    <label>이메일</label>
								<input type="email" id="user_email" name="user_email" value="${avo.user_email }">  
			                </div>
			
			                <div class="field">
			                    <label>전화번호</label>
			                    <input type="text" id="user_pnum" name="user_pnum" value="${avo.user_pnum }">
			                </div>
			                
			                <div class="field">
			                	<label style="display: none;">생년월일</label>  
			                	<input type="hidden" id="user_birth" name="user_birth" value="${avo.user_birth }"/>
			                </div>
			               	<input type="hidden" id="user_rank" name="user_rank" value="${avo.user_rank }"/>
			            </div>
		            </c:forEach>
		        </div>
	        <div class="clear"></div>
	</form>
	        <div id="footer">
	            <button id="updateUser_btn" type="button"  class="ui button">수정</button>
	            <button id="update_cancel_btn" onClick="closeModal();" class="ui button">취소</button>
	        </div>
	        
	            
	    </div>
    </div> 
</body>
</html>